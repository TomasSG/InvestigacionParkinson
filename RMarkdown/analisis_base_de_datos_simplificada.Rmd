---
title: "Análisis Base de Datos Simplificada"
author: "Tomás Sánchez Grigioni"
date: "13/9/2020"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.align = "center")
options(knitr.kable.NA = " ")
```

```{r, include = FALSE}
# Bibliotecas
library(knitr)
library(readxl)
library(dplyr)
library(ggpubr)
library(ggplot2)
library(lubridate)

# Funciones utiles
source("../R/Utils.R")
```

## Análisis de Datos

Las variables con las que se va a trabajar son:

|Nombre Variable Original|Nombre Variable Nuevo|Significado|Tipo Variable|
|:--|:--|:----|:-:|
|healthCode|-|-|-|
|healthCode1|-|Es el identificador del paciente|-|
|ROW_ID|id|Es el identificador de fila|-|
|DIAGNOSTICO|diagnostico|Resultado del diagnóstico|Categórica|
|d1|d1|Mean of logarithmic F0 on a semitone frequency scale|Continua|
|d2|d2|Mean of the ratio of the energy of the spectral harmonic peak at the first formant’s center frequency to the energy of the spectral peak at F0 in voiced regions|Continua|
|d3|d3| Coefficient of variation of the ratio of the energy of the spectral harmonic peak at the first formant’s center frequency to the energy of the spectral peak at F0 in voiced regions|Continua|
|d4|d4|Mean of linear regression slope of the logarithmic power spectrum within 0–500 Hz band entropy.|Continua|
|d5|d5|Mean Jitter of the deviations in individual consecutive F0 period lengths.|Continua|
|medTimePoint|punto_medicacion|Punto de toma de medicación|Cualitativa|
|age|edad|Edad del paciente|Discreta|
|are-caretaker|cuidado|Esta con cuidado|Cualitativa|
|deep-brain-stimulation|estimulacion_cerebral|Presenta estimulacion cerebral|Cualitativa|
|diagnosis-year|anio_diagnostico|Año en que le diagnosticaron la enfermedad|Discreta|
|education|educacion|Nivel de educacion|Cualitativa|
|employment|trabajo|Trabajo del paciente|Cualitativa|
|gender|genero|Genero del paciente|Cualitativa|
|maritalStatus|estado_civil|Estado civil|Cualitativa|
|medication-start-year|anio_medicacion|Año en que comenzo a medicarse|Discreta|
|onset-year|anio_enfermedad|Año en que se manifesto la enfermedad|Discreta|
|smartphone|facilidad_celular|Facilidad con la que usa el celular|Cualitativa|
|smoked|fumo|Si fumo|Cualitativa|
|surgery|cirugias|Si presenta cirugías|Cualitativa|
|years-smoking|anios_fumo|Cantidad de años que fumo|Discreta|


Primero cargamos los datos, luego observamos como los trata R.

```{r, message = FALSE}
# Código hacer join entre las tablas
datos_izq <- read_excel("../data/bd_acotada.xlsx") %>% 
  select(ROW_ID, DIAGNOSTICO, d1, d2, d3, d4, d5)

datos_der <- read_excel("../data/bd.xlsx") %>% 
   select(healthCode1, 
          medTimepoint, 
          "F0semitoneFrom27#5Hz_sma3nz_amean", 
          "F0semitoneFrom27#5Hz_sma3nz_stddevNorm",
          "F0semitoneFrom27#5Hz_sma3nz_percentile20#0", 
          "F0semitoneFrom27#5Hz_sma3nz_percentile50#0", 
          "F0semitoneFrom27#5Hz_sma3nz_percentile80#0", 
          "F0semitoneFrom27#5Hz_sma3nz_pctlrange0-2",
          "F0semitoneFrom27#5Hz_sma3nz_meanRisingSlope", 
          "F0semitoneFrom27#5Hz_sma3nz_stddevRisingSlope",
          "F0semitoneFrom27#5Hz_sma3nz_meanFallingSlope", 
          "F0semitoneFrom27#5Hz_sma3nz_stddevFallingSlope",
          "jitterLocal_sma3nz_amean", 
          "jitterLocal_sma3nz_stddevNorm", 
          "shimmerLocaldB_sma3nz_amean",
          "shimmerLocaldB_sma3nz_stddevNorm", 
          ROW_ID2, age, 
          "are-caretaker", 
          "deep-brain-stimulation",
          "diagnosis-year", 
          education, 
          employment, 
          gender, 
          maritalStatus, 
          "medication-start-year", 
          "onset-year",
          smartphone, 
          smoked, 
          surgery, 
          "years-smoking", 
          healthCode) %>% 
  rename(ROW_ID = ROW_ID2)
 
datos_crudos <- inner_join(datos_izq, datos_der, by = "ROW_ID") %>% distinct()


rm(datos_izq,datos_der)


# Cambiamos los nombres para que concida con la tabla
datos_it0 <- datos_crudos %>%
  rename(id = ROW_ID, 
         diagnostico = DIAGNOSTICO, 
         punto_medicacion = medTimepoint, 
         edad = age,
         cuidado = "are-caretaker", 
         estimulacion_cerebral	 = "deep-brain-stimulation",
         anio_diagnostico = "diagnosis-year", 
         educacion = education, 
         trabajo = employment,
         genero = gender, 
         estado_civil = maritalStatus, 
         anio_medicacion = "medication-start-year",
         anio_enfermedad = "onset-year", 
         facilidad_celular = smartphone, 
         fumo = smoked,
         cirugias = surgery, 
         anios_fumo = "years-smoking") 



str(datos_it0)
```

Los problemas que encontramos son:

* **diagnostico** no es un factor.
* **punto_medicacion** no es un factor.
* **cuidado** no es un factor.
* **estimulacion_cerebral** no es un factor.
* **anio_diagnostico** no es una fecha.
* **educacion** no es un factor.
* **trabajo** no es un factor.
* **genero** no es un factor.
* **estado_civil** no es un factor.
* **anio_medicacion** no es una fecha
* **anio_enfermedad** no es una fecha.
* **facilidad_celular** no es un factor.
* **fumo** no es un factor.
* **cirugias** no es un factor.
* **anios_fumo** no es un número.
* Además le cambiamos lo nombres a las variables para que sea más manejable.

```{r}
#Reemplazamos todos los NULL con NA
datos_it0[datos_it0 == "NULL"] <- NA


datos_it1 <- datos_it0 %>%
  mutate(diagnostico = as.factor(diagnostico),
         punto_medicacion = as.factor(punto_medicacion),
         cuidado = as.factor(cuidado),
         estimulacion_cerebral = as.factor(estimulacion_cerebral),
         educacion = as.factor(educacion),
         trabajo = as.factor(trabajo),
         genero = as.factor(genero),
         estado_civil = as.factor(estado_civil),
         facilidad_celular = as.factor(facilidad_celular),
         fumo = as.factor(fumo),
         cirugias = as.factor(cirugias),
         anio_medicacion = as.numeric(anio_medicacion),
         anio_enfermedad = as.numeric(anio_enfermedad),
         anio_diagnostico = as.numeric(anio_diagnostico),
         anios_fumo = as.numeric(anios_fumo))

str(datos_it1)
```

Ahora las variables se tratan correctamente. Calculamos las medidas resumen para las variables cuantitativas y creamos tablas de frecuencia para variables cualitativas

```{r}
# Para variables cualtiativas
df_aux_cuanti <- datos_it1 %>%
  select(where(is.numeric)) %>%
  mutate(id = NULL)

lista_aux <- list(data = df_aux_cuanti, nombre_var = names(df_aux_cuanti))

kable(pmap_dfr(lista_aux, medidas_resumen, remover_na = TRUE), 
      caption = "Medidas Resumen de Variables Cuantitativas", digits = 2)

# Para variables cuantitativas
df_aux_cuali <- datos_it1 %>%
  select(where(is.factor))

kable(summary(df_aux_cuali), caption = "Frecuencias de Variables Cualitativas")

rm(df_aux_cuanti, df_aux_cuali, lista_aux)

```

De las variables cuantitativas los problemas que se encuentran son que:

* **anio_medicacion** presenta una media en 1429.44 indicando que hay valores muy chicos que distorsionan la verdadera media. Luego, observamos que el primer cuartil tiene valor 0. Estos valores es posible que indiquen que esa persona no toma medicaciones y en su lugar se debería reemplazar estas observaciones con NA para que no interfieran.

Realizamos algunas verificaciones para determinar que no hay otros errores de este estilo.

```{r,include = FALSE}

# Algunas validaciones

# Buscamos gente de las variables anios con un valor de 0
nrow(datos_it1 %>% filter(edad == 0))
nrow(datos_it1 %>% filter(anios_fumo == 0))
nrow(datos_it1 %>% filter(anio_diagnostico == 0))
nrow(datos_it1 %>% filter(anio_medicacion == 0))
nrow(datos_it1 %>% filter(anio_enfermedad == 0))

# Buscamos gente que fumo pero con anios_fumo igual a 0
nrow(datos_it1 %>% filter(tolower(fumo) == "true" & anios_fumo == 0))

# Buscamos gente con anio de medicacion con valores muy chicos
nrow(datos_it1 %>% filter(anio_medicacion < 1980) %>% select(anio_medicacion))

# Gente con que tiene más años fumando que edad
nrow(datos_it1 %>% filter(anios_fumo >= edad))

# Buscamos gente que no fumo pero tiene algun valo en anio_fumo
nrow(datos_it1 %>% filter(fumo == "false") %>% filter(anios_fumo != 0))

```

Por la presencia de los 0s en la variable **anios_fumo** decidimos reemplazarlos por NAs. Además, completamos con NAs aquellos valores que sean anteriores a 1980 en la variable **anio_medicacion**.

```{r}
datos_it2 <- datos_it1
datos_it2$anios_fumo[datos_it2$anios_fumo == 0] <- NA
datos_it2$anio_medicacion[datos_it2$anio_medicacion < 1980] <- NA
```

Empezamos realizando gráficos de una sola variable

```{r}

g0 <- ggplot(datos_it2) + ylab("")

# Histogramas de variables di
g1 <- g0 + geom_histogram(aes(d1), bins = calcular_cant_bins(sum(!is.na(datos_it1$d1))), alpha = 0, color = "black")
g2 <- g0 + geom_histogram(aes(d2), bins = calcular_cant_bins(sum(!is.na(datos_it1$d2))), alpha = 0, color = "black")
g3 <- g0 + geom_histogram(aes(d3), bins = calcular_cant_bins(sum(!is.na(datos_it1$d3))), alpha = 0, color = "black")
g4 <- g0 + geom_histogram(aes(d4), bins = calcular_cant_bins(sum(!is.na(datos_it1$d4))), alpha = 0, color = "black")
g5 <- g0 + geom_histogram(aes(d5), bins = calcular_cant_bins(sum(!is.na(datos_it1$d5))), alpha = 0, color = "black")

arrange <- ggarrange(g1, g2, g3, g4, g5, nrow = 2, ncol = 3)

annotate_figure(arrange,top = text_grob("Histograma variables di"))

rm(g1, g2, g3, g4, g5, arrange)
```
En **d1** parece ser que los datos se concentran entre los valores de 20 y 40, teniendo algunas observaciones por fuera de este intervalo.

En **d2** los datos parecen estar centrados en 0, pero presenta una cola con algunas observaciones para los números negativos.

En **d3** todas las observaciones se encuentran distribuidas entre 0 y 0.6, con gran cantidad de observaciones en los valores intermedios.

En **d4** todas las observaciones se encuentran distribuidas entre 0 y 0.15, pero con mayor cantidad de observaciones para los valores que se encuentran entre 0.05 0.10.

En **d5** se presenta la mayor cantidad de observaciones en los valores más cercanos a 0 de esta variable. Teniendo también observaciones para valores mayores a 0.10, pero en menor medida.

```{r}
# Boxplot de variables di
g1 <- g0 + geom_boxplot(aes(d1))
g2 <- g0 + geom_boxplot(aes(d2))
g3 <- g0 + geom_boxplot(aes(d3))
g4 <- g0 + geom_boxplot(aes(d4))
g5 <- g0 + geom_boxplot(aes(d5))

arrange <- ggarrange(g1, g2, g3, g4, g5, nrow = 2, ncol = 3)

annotate_figure(arrange,top = text_grob("Boxplot variables di"))

rm(g1, g3, g4, arrange)
```
En **d1** se tiene la mediana cercana a 25, y el 50% central de los datos parecen estar contenidos entre 25 y 30 aproximadamente. Hay gran presencia de valores extremos.

En **d2** hay gran presencia de valores extremos por lo que se distorsiona el gráfico, posteriormente realizamos un zoom a la zona de interés.

En **d3** la mediana pareciera estar cerca de 0.2 y el 50% central entre 0.1 y 0.3, aprozimadamente. Presenta un único valor extremo.

En **d4** la mediana se encuentra cercana a 0.1, con el 50% central entre 0.08 y 0.1. Hay varios valores extremos.

En **d5** hay gran presencia de valores extremos, por lo que realizamos un zoom para analizar.

```{r}
# Boxplot de variables di
g2 <- g2 + coord_cartesian(xlim = c(-25, 25))
g5 <- g5 + coord_cartesian(xlim = c(0, 0.025))

arrange <- ggarrange(g2, g5, nrow = 1, ncol = 2)

annotate_figure(arrange,top = text_grob("Boxplot con zoom"))

rm(g2, g5, arrange)
```
En **d2** la mediana se encuentra cercana a -5 y el 50% central de los datos entre -50 y 0, aproximadamente.

En **d5** la mediana se encuentra aproximadamente en 0.010, con el 50% central entre 0.005 y 0.020 aproximadamente.

```{r}
# Histogramas de variables anios
g1 <- g0 + geom_histogram(aes(edad), bins = calcular_cant_bins(sum(!is.na(datos_it1$edad))), 
                          alpha = 0, color = "black", na.rm = TRUE)
g2 <- g0 + geom_histogram(aes(anios_fumo), bins = calcular_cant_bins(sum(!is.na(datos_it1$anios_fumo))), 
                          alpha = 0, color = "black", na.rm = TRUE)
g3 <- g0 + geom_histogram(aes(anio_diagnostico), bins = calcular_cant_bins(sum(!is.na(datos_it1$anio_diagnostico))), 
                          alpha = 0, color = "black", na.rm = TRUE)
g4 <- g0 + geom_histogram(aes(anio_medicacion), bins = calcular_cant_bins(sum(!is.na(datos_it1$anio_medicacion))), 
                          alpha = 0, color = "black", na.rm = TRUE)
g5 <- g0 + geom_histogram(aes(anio_enfermedad), bins = calcular_cant_bins(sum(!is.na(datos_it1$anio_enfermedad))), 
                          alpha = 0, color = "black", na.rm = TRUE)

arrange <- ggarrange(g1, g2, g3, g4, g5,  nrow = 2, ncol = 3)

annotate_figure(arrange,top = text_grob("Histograma variables de anios"))

rm(g1, g2, g3, g4, g5, arrange)
```
En **edad** encontramos que las observaciones parecieran distribuirse uniformemente en el rango de 40 y 70, con algunas pocas observaciones extras para edades superiores a 70.

En **anios_fumo** encontramos que existen observaciones de valores entre 1 y 50 prácticamente. Pero la mayo cantidad de observaciones se centran en los 15 años aproximadamente.

En **anio_diagnostico** la mayor cantidad de observaciones se encuentran cerca del año 2010, pero existen algunas observaciones para los años menores a 2000.

En **anio_medicacion** encontramos gran cantidad de observaciones cercanas al año 2010, y unas pocas para los años menores a 200.

En **anio_enfermedad** la mayor cantidad de observaciones se encuentran cerca del año 2010, pero existen algunas observaciones para los años menores a 2000.

```{r}
# Boxplot de variables anios
g1 <- g0 + geom_boxplot(aes(edad), na.rm = TRUE)
g2 <- g0 + geom_boxplot(aes(anios_fumo), na.rm = TRUE)

arrange <- ggarrange(g1, g2, nrow = 1, ncol = 2)

annotate_figure(arrange,top = text_grob("Boxplot variables de anios"))

rm(g1, g2, arrange)
```
En **edad** parece que la mediana se encuentra cercana a 52 años, con el 50% central de los datos desde los 45 hasta los 62 aproximadamente. No hay presencia de valores extremos.

En **anios_fumo** la mediana parece encontrarse cerca de los 10 años. El 50% central de los datos va desde los 5 años hasta los 20. Existen algunos valores extremos.

```{r}
g0 + geom_bar(aes(diagnostico, y = ..count.. / sum(..count..)), na.rm = TRUE)
kable(table(datos_it2$diagnostico))
```
En **diagnostico** más de la mitad de los datos corresponden a diagnósticos negativos, y el resto a diagnosticos positivos.

```{r}
g0 + geom_bar(aes(punto_medicacion, y = ..count.. / sum(..count..)), na.rm = TRUE) + coord_flip()
kable(table(datos_it2$punto_medicacion))
```

En **punto_medicacion** el 60% de los datos corresponden a personas que no toman medicación para parkinson. Luego sigue, "Another time", "Just After Parkinson medication" y "Immediately before Parkinson medication".

```{r}
g0 + geom_bar(aes(cuidado, y = ..count.. / sum(..count..)), na.rm = TRUE)
```
En **cuidado** más del 80% de las personas se respondieron falso, casi el 5% si y el resto no respondio.


```{r}
g0 + geom_bar(aes(estimulacion_cerebral, y = ..count.. / sum(..count..)), na.rm = FALSE)
kable(table(datos_it2$estimulacion_cerebral))
```
En **estimulacion_cerebral** más del 80% de los datos respondieron fallos, más del 10% no respondieron y el resto verdadero.

```{r}
g0 + geom_bar(aes(educacion, y = ..count.. / sum(..count..)), na.rm = TRUE) + coord_flip()
kable(table(datos_it2$educacion))
```
En **educacion** se presenta la mayor cantidad de observaciones con "4-year college degree", seguido por "Masters Degree". En tercer lugar se tiene "Some college" y en cuarto "Doctoral Degree".

```{r}
g0 + geom_bar(aes(trabajo, y = ..count.. / sum(..count..)), na.rm = TRUE) + coord_flip()
kable(table(datos_it2$trabajo))
```
En **educacion** la mayor cantidad de los datos corresponden por "Empoyment for wages", seguido por "Retired" y "Self-employed".

```{r}
g0 + geom_bar(aes(genero, y = ..count.. / sum(..count..)), na.rm = TRUE)
kable(table(datos_it2$genero))
```
En **genero** más del 70% de los datos corresponden a hombres, y un poco menos del 30% a mujeres.



```{r}
g0 + geom_bar(aes(estado_civil), na.rm = TRUE) + coord_flip()
g0 + geom_bar(aes(facilidad_celular), na.rm = TRUE) + coord_flip()
g0 + geom_bar(aes(fumo), na.rm = TRUE)
g0 + geom_bar(aes(cirugias), na.rm = TRUE)

rm(g0)
```

