---
title: "Análisis Exploratorio de Datos"
author: "Tomás Sánchez Grigioni"
date: "2020-12-14"
output: html_notebook
---


```{r setup, echo = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Bibliotecas a utilizar

Encontramos la lista de bibliotecas a utilizar aqui, con el fin de por qué las incluimos. Además, cargamos el archivo que contiene funciones importantes a utilizar.

```{r bibliotecas}
# Para anaálisis de datos
library(tidyverse)
library(lubridate)

# Para RMarkdown
library(knitr)
library(kableExtra)
library(tinytex)

# Para cargar datos
library(readxl)

# Para customizar ggplot
library(ggpubr)
library(ggthemes)
library(extrafont)
library(scales)

# Funciones utiles
source("../R/Utils.R")
```


## Importar los datos

La información de las variables se puede extraer de este [link](https://www.synapse.org/#!Synapse:syn4993293/wiki/390372)

Los datos en principio los tenemos divididos en dos bases de datos, así que mediante un join generamos la vase de datos a utilizar.

```{r datos_join}
# Código hacer join entre las tablas
datos_izq <- read_excel("../data/bd_acotada.xlsx") %>% 
  select(ROW_ID, d1, d2, d3, d4, d5)

datos_der <- read_excel("../data/bd_completa.xlsx") %>% 
   select(ROW_ID2, 
          age, 
          "are-caretaker", 
          "deep-brain-stimulation",
          "diagnosis-year", 
          education, 
          employment, 
          gender, 
          "healthcare-provider",
          maritalStatus, 
          "medication-start-year", 
          "onset-year",
          "packs-per-day",
          smartphone, 
          smoked, 
          surgery, 
          "video-usage",
          "years-smoking",
          "professional-diagnosis") %>% 
  rename(ROW_ID = ROW_ID2)
```

Verificamos la cantidad de IDs repetidos.

```{r ids_repetidos}
contar_ids_repetidos(datos_izq, ROW_ID)
contar_ids_repetidos(datos_der, ROW_ID)
```
Observamos que en datos_der existen 139 IDs duplicados. Lo que vamos a hacer es obtener estos y observar las filas repetidas.

```{r}
row_id_duplicado <- datos_der %>% 
  count(ROW_ID) %>% 
  filter(n > 1) %>% 
  select(ROW_ID)

datos_der %>% 
  filter(ROW_ID %in% row_id_duplicado$ROW_ID) %>% 
  arrange(ROW_ID)
```

Aqui podemos ver como en realidad para las variables incluidas, se tratan de observaciones repetidas, entonces lo que hacemos es limpiarlos

```{r datos_der_sin_duplicados}
datos_der <- datos_der %>% distinct(ROW_ID, .keep_all = TRUE)

contar_ids_repetidos(datos_der, ROW_ID)
```

Observamos que no tenemos datos duplicados, realizamos el join

```{r datos_crudos}
datos_crudos <- left_join(datos_izq, datos_der, by = "ROW_ID")
```

Comenzamos renombando todas las variables, para manegarlas de forma más sencilla. Observamos como trata a cada variable.

```{r datos_it0}
datos_it0 <- datos_crudos %>%
  rename(id = ROW_ID,
         edad = age,
         es_cuidador = `are-caretaker`,
         dbs = `deep-brain-stimulation`,
         anio_diagnostico = `diagnosis-year`,
         educ = education,
         empleo = employment,
         genero = gender,
         tipo_medico = `healthcare-provider`,
         estado_marital = maritalStatus,
         anio_comienzo_med = `medication-start-year`,
         anio_comienzo_sintomas = `onset-year`,
         paquetes_por_dia = `packs-per-day`,
         facilidad_celular = smartphone,
         fumo = smoked,
         cirugia = surgery,
         videollamada = `video-usage`,
         anios_fumo = `years-smoking`,
         diagnostico_pro = `professional-diagnosis`)

# Lo hacemos un poco más complejo para que sea mas legible el output
tibble("Nombre" = names(datos_it0), "Clase" = map_chr(datos_it0, class))
```

```{r, echo = FALSE}
#Para limpiar el entorno de trabajo
rm(datos_izq, datos_der, row_id_duplicado)
```

Aqui encontramos que se trata a muchas variables como character en lugar de factor o numérico.

```{r datos_it1}

# Los que no respondieron una pregunta figura como NULL, entonces para hacer más fácil los reemplazo con NA.
datos_it0[datos_it0 == "NULL"] <- NA

datos_it1 <- datos_it0 %>%
  mutate(es_cuidador = factor(es_cuidador),
         dbs = factor(dbs),
         anio_diagnostico = as.numeric(anio_diagnostico),
         educ = factor(educ),
         empleo = factor(empleo),
         genero = factor(genero),
         tipo_medico = factor(tipo_medico),
         estado_marital = factor(estado_marital),
         anio_comienzo_med = as.numeric(anio_comienzo_med),
         anio_comienzo_sintomas = as.numeric(anio_comienzo_sintomas),
         paquetes_por_dia = as.numeric(paquetes_por_dia),
         facilidad_celular = factor(facilidad_celular),
         fumo = factor(fumo),
         cirugia = factor(cirugia),
         videollamada = factor(videollamada),
         anios_fumo = as.numeric(anios_fumo),
         diagnostico_pro = factor(diagnostico_pro))
```

## Limpieza de los datos

Comenzamos realizando unas validaciones para encontrar incosistencias en los datos.

```{r}
# Comezamos verificando que no encontremos valores absurdos en las varaibloes
range(datos_it1$edad)
range(datos_it1$anio_diagnostico, na.rm = TRUE)
range(datos_it1$anio_comienzo_med, na.rm = TRUE)
```
Como dice la documentación de las variables, para esta variable se debe tipear 0 si no se empezo a tomar medicación. Entonces lo que vamos a hacer es reemplazar esos valores con NA.

```{r datos_it2}
datos_it2 <- datos_it1 %>% 
  mutate(anio_comienzo_med = replace(anio_comienzo_med, anio_comienzo_med < 1970, NA))
```

Seguimos verificando el resto de variables.

```{r}
range(datos_it2$anio_comienzo_sintomas, na.rm = TRUE)
range(datos_it2$paquetes_por_dia, na.rm = TRUE)
range(datos_it2$anios_fumo, na.rm = TRUE)

# Verificamos que no existe gente que no fuma pero tenga paquetes por dia
datos_it2 %>% filter(fumo == "false" & paquetes_por_dia > 0) %>% nrow()

# Verificamos que no exista gente que no fuma pero tenga anios fumo
datos_it2 %>% filter(fumo == "false" & anios_fumo > 0) %>% nrow()

# Vericiamos que no exista gente sin diagnóstico profesional pero que tenga anio de diagnóstico
datos_it2 %>% filter(diagnostico_pro == "false" & anio_diagnostico > 0) %>% nrow()
```

Estas son algunas de las verificaciones que hacemos. A medida que avanzemos en el análisis vamos a seguir haciendo.

### Análisis univariado

Vamos a empezar calculando las medidas resumen más importante de cada variable. Comenzamos con las cuantitativas.

```{r medidas_resumen_cuantitativa}

df_resultado <- tibble(q1 = numeric(), Media = numeric(), Mediana = numeric(), q3 = numeric(), Desvio = numeric())
df_for <- datos_it2 %>%  select(where(is.numeric))

for( i in seq_along(df_for)) {
    df_resultado %>% add_row(
      q1 = quantile(df_for[[i]], .25, na.rm = TRUE),
      Media = mean(df_for[[i]], na.rm = TRUE),
      Mediana = median(df_for[[i]], na.rm = TRUE),
      q3 = quantile(df_for[[i]], .75, na.rm = TRUE),
      Desvio = sd(df_for[[i]], na.rm = TRUE))
  
  names(df_resultado)[i] = names(df_for)[i]
}

rm(df_resultado, df_for)
```



















