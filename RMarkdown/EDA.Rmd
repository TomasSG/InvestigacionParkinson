---
title: "Análisis Exploratorio de Datos"
author: "Tomás Sánchez Grigioni"
date: "2020-12-14"
output: html_notebook
---


```{r setup, echo = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Bibliotecas a utilizar

Encontramos la lista de bibliotecas a utilizar aqui, con el fin de por qué las incluimos. Además, cargamos el archivo que contiene funciones importantes a utilizar.

```{r bibliotecas}
# Para anaálisis de datos
library(tidyverse)
library(lubridate)

# Para RMarkdown
library(knitr)
library(kableExtra)
library(tinytex)

# Para cargar datos
library(readxl)

# Para customizar ggplot
library(ggpubr)
library(ggthemes)
library(extrafont)
library(scales)

# Funciones utiles
source("../R/Utils.R")
```


## Importar los datos

La información de las variables se puede extraer de este [link](https://www.synapse.org/#!Synapse:syn4993293/wiki/390372)

Los datos en principio los tenemos divididos en dos bases de datos, así que mediante un join generamos la vase de datos a utilizar.

```{r datos_join}
# Código hacer join entre las tablas
datos_izq <- read_excel("../data/bd_acotada.xlsx") %>% 
  select(ROW_ID, d1, d2, d3, d4, d5)

datos_der <- read_excel("../data/bd_completa.xlsx") %>% 
   select(ROW_ID2, 
          age, 
          "are-caretaker", 
          "deep-brain-stimulation",
          "diagnosis-year", 
          education, 
          employment, 
          gender, 
          "healthcare-provider",
          maritalStatus, 
          "medication-start-year", 
          "onset-year",
          "packs-per-day",
          smartphone, 
          smoked, 
          surgery, 
          "video-usage",
          "years-smoking",
          "professional-diagnosis") %>% 
  rename(ROW_ID = ROW_ID2)
```

Verificamos la cantidad de IDs repetidos.

```{r ids_repetidos}
contar_ids_repetidos(datos_izq, ROW_ID)
contar_ids_repetidos(datos_der, ROW_ID)
```
Observamos que en datos_der existen 139 IDs duplicados. Lo que vamos a hacer es obtener estos y observar las filas repetidas.

```{r}
row_id_duplicado <- datos_der %>% 
  count(ROW_ID) %>% 
  filter(n > 1) %>% 
  select(ROW_ID)

datos_der %>% 
  filter(ROW_ID %in% row_id_duplicado$ROW_ID) %>% 
  arrange(ROW_ID)
```

Aqui podemos ver como en realidad para las variables incluidas, se tratan de observaciones repetidas, entonces lo que hacemos es limpiarlos

```{r datos_der_sin_duplicados}
datos_der <- datos_der %>% distinct(ROW_ID, .keep_all = TRUE)

contar_ids_repetidos(datos_der, ROW_ID)
```

Observamos que no tenemos datos duplicados, realizamos el join

```{r datos_crudos}
datos_crudos <- left_join(datos_izq, datos_der, by = "ROW_ID")
```

Comenzamos renombando todas las variables, para manegarlas de forma más sencilla. Observamos como trata a cada variable.

```{r datos_it0}
datos_it0 <- datos_crudos %>%
  rename(id = ROW_ID,
         edad = age,
         es_cuidador = `are-caretaker`,
         dbs = `deep-brain-stimulation`,
         anio_diagnostico = `diagnosis-year`,
         educ = education,
         empleo = employment,
         genero = gender,
         tipo_medico = `healthcare-provider`,
         estado_marital = maritalStatus,
         anio_comienzo_med = `medication-start-year`,
         anio_comienzo_sintomas = `onset-year`,
         paquetes_por_diar = `packs-per-day`,
         facilidad_celular = smartphone,
         fumo = smoked,
         cirugia = surgery,
         videollamada = `video-usage`,
         anios_fumo = `years-smoking`,
         diagnostico_pro = `professional-diagnosis`)

# Lo hacemos un poco más complejo para que sea mas legible el output
tibble("Nombre" = names(datos_it0), "Clase" = map_chr(datos_it0, class))
```

```{r, echo = FALSE}
#Para limpiar el entorno de trabajo
rm(datos_izq, datos_der, row_id_duplicado)
```

Aqui encontramos que se trata a muchas variables como character en lugar de factor o numérico.

```{r datos_it1}
datos_it1 <- datos_it0 %>%
  mutate(diagnostico = as.factor(diagnostico),
         punto_medicacion = as.factor(punto_medicacion),
         cuidado = as.factor(cuidado),
         estimulacion_cerebral = as.factor(estimulacion_cerebral),
         educacion = as.factor(educacion),
         trabajo = as.factor(trabajo),
         genero = as.factor(genero),
         estado_civil = as.factor(estado_civil),
         facilidad_celular = as.factor(facilidad_celular),
         fumo = as.factor(fumo),
         cirugias = as.factor(cirugias),
         anio_medicacion = as.numeric(anio_medicacion),
         anio_enfermedad = as.numeric(anio_enfermedad),
         anio_diagnostico = as.numeric(anio_diagnostico),
         anios_fumo = as.numeric(anios_fumo))
```

Vemos que se insertaron unos NAs cuando realizamos el mutate, buscamos esos valores para ver este problema

```{r}
datos_it0 %>% select(anio_medicacion, anio_enfermedad, anio_diagnostico, anios_fumo)
```

Nos damos cuenta que el problema es que para omitir los valores se escribe NULL, pero no es ningún incoveniente porque esos valores se reemplazaron por NA. Lo que vamos a hacer ahora es ver con cuantas filas nos quedamos si eliminamos los NA (que nacieron a partir de los NULL).

```{r}
datos_it1 %>% drop_na() %>% nrow()
datos_it1 %>% nrow()
```

No hay que eliminar los NA porque nos quedamos con muy pocas observaciones, en su lugar simplemente los ignoramos cuando analizamos las variables.

## Limpieza de los datos

Comenzamos realizando unas validaciones para encontrar incosistencias en los datos.

```{r}
# Verificamos que no haya valores absurdos para edad
range(datos_it1$edad)

# Verificamos que no haya valores absurdos para anio diagnostico
range(datos_it1$anio_diagnostico, na.rm = TRUE)

# Verificamos que no exista gente sin parkinson pero con un anio de diagnostico
datos_it1 %>% filter(diagnostico == 0 & anio_diagnostico > 0)

# Verificamos que no haya valores absurdos para anio medicaion
range(datos_it1$anio_medicacion, na.rm = TRUE)
```
Observamos que tenemos valores absurdos para anio medicacion, lo que tenemos que hace es en que momento cortar. Dado que el minimo de anio diagnostico es 1976, los valores mínimos de anio medicacion debería encontrarse por ahí.

```{r datos_it2}
datos_it2 <- datos_it1 %>% filter(anio_medicacion >= 1970 | is.na(anio_medicacion))
```

Encontramos que existian cerca de 350 valores menores a 1970, pensamos que son absurdos y que hay que eliminarlos.

Seguimos verificando el resto de variables.

```{r}
# Buscamos valores absurdos en anio enferemedad
range(datos_it2$anio_enfermedad, na.rm = TRUE)

# Buscamos gente que no tenga parkinson pero si un anio enfermedad
datos_it2 %>% filter(diagnostico == 0 & anio_enfermedad > 0) %>% select(diagnostico, anio_enfermedad)
```

